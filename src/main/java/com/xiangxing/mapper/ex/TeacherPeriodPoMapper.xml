<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xiangxing.mapper.ex.TeacherPeriodPoMapper" >

  <select id="teacherPeriodData" resultType="com.xiangxing.model.ex.TeacherPeriodPo">
  SELECT * FROM (
SELECT t1.id,t1.`name` AS teacherName,SUM(IFNULL(t2.period,0)) AS weekPeriod FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND YEAR(t2.create_time)=YEAR(NOW()) AND WEEK(t2.create_time)=WEEK(NOW())
WHERE t1.school_id=#{schoolId}
GROUP BY t1.id
) t1
JOIN (
SELECT t1.id,SUM(IFNULL(t2.period,0)) AS thisMonthPeriod FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND YEAR(t2.create_time)=YEAR(NOW()) AND MONTH(t2.create_time)=MONTH(NOW())
WHERE t1.school_id=#{schoolId}
GROUP BY t1.id
) t2 ON t1.id=t2.id
JOIN (
SELECT t1.id,SUM(IFNULL(t2.period,0)) AS lastMonthPeriod FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND DATE_FORMAT(t2.create_time,'%Y-%m')=DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 MONTH),'%Y-%m')
WHERE t1.school_id=#{schoolId}
GROUP BY t1.id
) t3 ON t1.id=t3.id ORDER BY t1.id
  </select>

  <select id="teacherPeriodDataByDate" resultType="com.xiangxing.model.ex.TeacherPeriodPo">
  <![CDATA[
  SELECT * FROM (
SELECT t1.id,t1.`name` AS teacherName,SUM(IFNULL(t2.period,0)) AS period FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND DATE(t2.create_time)>=DATE(#{startDate}) AND DATE(t2.create_time)<=DATE(#{endDate})
WHERE t1.school_id=#{schoolId}
GROUP BY t1.id
) t ORDER BY t.id
]]>
  </select>

  <select id="schoolTotalPeriodData" resultType="com.xiangxing.model.ex.TeacherPeriodPo">
  SELECT * FROM (
SELECT '1' AS id,IFNULL(SUM(t2.period),0) AS weekPeriod FROM t_teacher t1
JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND YEAR(t2.create_time)=YEAR(NOW()) AND WEEK(t2.create_time)=WEEK(NOW())
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
) t1
JOIN (
SELECT '1' AS id,IFNULL(SUM(t2.period),0) AS thisMonthPeriod FROM t_teacher t1
JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND YEAR(t2.create_time)=YEAR(NOW()) AND MONTH(t2.create_time)=MONTH(NOW())
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
) t2 ON t1.id=t2.id
JOIN (
SELECT '1' AS id,IFNULL(SUM(t2.period),0) AS lastMonthPeriod FROM t_teacher t1
JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND DATE_FORMAT(t2.create_time,'%Y-%m')=DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 MONTH),'%Y-%m')
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
) t3 ON t1.id=t3.id
JOIN (
SELECT '1' AS id,SUM(t.period)-SUM(t.p) AS surplusPeriod FROM (
SELECT t4.period,SUM(t2.period) p FROM t_teacher t1
JOIN t_teacher_period t2 ON t1.id=t2.teacher_id
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
JOIN t_course t4 ON t2.course_id=t4.id
GROUP BY t4.id
) t
) t4 ON t1.id=t4.id
  </select>

  <select id="schoolPeriodData" resultType="com.xiangxing.model.ex.TeacherPeriodPo">
  SELECT * FROM (
SELECT t3.id,t3.`name` AS schoolName,SUM(IFNULL(t2.period,0)) AS weekPeriod FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND YEAR(t2.create_time)=YEAR(NOW()) AND WEEK(t2.create_time)=WEEK(NOW())
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
GROUP BY t3.id
) t1
JOIN (
SELECT t3.id,SUM(IFNULL(t2.period,0)) AS thisMonthPeriod FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND YEAR(t2.create_time)=YEAR(NOW()) AND MONTH(t2.create_time)=MONTH(NOW())
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
GROUP BY t3.id
) t2 ON t1.id=t2.id
JOIN (
SELECT t3.id,SUM(IFNULL(t2.period,0)) AS lastMonthPeriod FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND DATE_FORMAT(t2.create_time,'%Y-%m')=DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 MONTH),'%Y-%m')
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
GROUP BY t3.id
) t3 ON t1.id=t3.id
JOIN (
SELECT t.id,SUM(t.period)-SUM(t.p) AS surplusPeriod FROM (
SELECT t3.id,t4.period,SUM(t2.period) p FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
JOIN t_course t4 ON t2.course_id=t4.id
GROUP BY t4.id,t3.id
) t GROUP BY t.id
) t4 ON t1.id=t4.id
  </select>

  <select id="schoolPeriodDataByDate" resultType="com.xiangxing.model.ex.TeacherPeriodPo">
  <![CDATA[
  SELECT t1.id,t1.schoolName,t1.period,t2.surplusPeriod FROM (
  SELECT * FROM (
SELECT t3.id,t3.`name` AS schoolName,SUM(IFNULL(t2.period,0)) AS period FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id AND DATE(t2.create_time)>=DATE(#{startDate}) AND DATE(t2.create_time)<=DATE(#{endDate})
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
GROUP BY t3.id
) t ORDER BY t.id
) t1 JOIN (
SELECT t.id,SUM(t.period)-SUM(t.p) AS surplusPeriod FROM (
SELECT t3.id,t4.period,SUM(t2.period) p FROM t_teacher t1
LEFT JOIN t_teacher_period t2 ON t1.id=t2.teacher_id
JOIN t_school t3 ON t1.school_id=t3.id AND t3.headquarters_id=#{headquartersId}
JOIN t_course t4 ON t2.course_id=t4.id
GROUP BY t4.id,t3.id
) t GROUP BY t.id
) t2 ON t1.id=t2.id

]]>
  </select>
 
</mapper>